# Использование LLM для извлечения структурированной информации из агрономических сообщений

![Warp demo](../../assets/003-warp-create-record-about-using-it.gif)

## Задача  
Преобразование неструктурированных сообщений агрономов (содержащих сленг, сокращения и ошибки) в строго структурированный JSON-формат, соответствующий заданной схеме данных о полевых работах.

## Использованный инструмент  

[GPT-4 (ChatGPT)](https://chatgpt.com/c/67ffd8b2-c4d4-800e-8d69-d51514e817b3) с поддержкой Constrained Decoding и встраиванием few-shot-примеров в системный промпт.

## Процесс

### 1. Формализация задачи
- Пользователь описал задачу: извлекать данные из текстов агрономов и представлять их в виде модели `FieldWorkLog`, содержащей записи `FieldWorkEntry`.
- Структура полей включала такие атрибуты, как дата, отдел, операция, культура, площади и урожайность.
- Были добавлены ограничения: значения некоторых полей строго из справочников, другие допускают свободный ввод (с пояснением от модели).

### 2. Расширение схемы с учётом неопределённости
- Для полей `operation`, `department_name`, `crop` была внедрена обёртка, позволяющая указывать:
  - `valid` — если значение из справочника,
  - `predict` — если значение угадано моделью на основе контекста (с пояснением),
  - `raw` — если значение явно указано в сообщении, но не входит в справочник (также с пояснением).
- Сформирована обобщённая схема `FieldWorkLogAnnotated`.

### 3. Создание few-shot примеров
- Пользователь подготовил вручную набор репрезентативных сообщений агрономов.
- Для каждого примера были вручную размечены правильные записи с полями и пояснениями.
- Создано описание для каждого примера (`explanation`) с разбором, как именно были интерпретированы значения.

### 4. Обновление системного промпта
- Промпт был адаптирован под новую логику с аннотированными полями.
- Удалены устаревшие инструкции (например, «не придумывать значения»), заменены на инструкции про `valid`, `predict` и `raw`.
- Интегрированы примеры в виде few-shot-контекста для обучения модели на практике.

### 5. Поддержка прямого и обратного преобразования
- Реализованы функции:
  - `convert_annotated_to_strict()` — для преобразования аннотированной записи обратно в строгий формат (с подстановкой значений по умолчанию при `raw`);
  - Конвертация старого формата в новый с `status: valid`.

### 6. Автоматизация сохранения и оценки
- Выгрузка результатов до и после обработки:
  - `raw_deepseek_demo_mode_evaluation_results.json` — с аннотированными полями;
  - `deepseek_demo_mode_evaluation_results.json` — с приведённым строгим JSON для подсчёта метрик.
- Обработка ошибок сериализации (`json.dump`) и сохранение объектов.

## Преимущества использования LLM

1. **Интерпретация неоднозначного текста**: распознавание смысла даже при опечатках, сленге и нестандартной структуре.  
2. **Гибкость представления**: возможность указывать степень уверенности модели в извлечённом значении.  
3. **Быстрое масштабирование**: возможность автоматически обрабатывать сотни сообщений без ручной разметки.  
4. **Формализация логики обработки**: перенос человеческих эвристик в явный код и примеры, которые понятны LLM.

## Ограничения

1. Требуется чёткая настройка системного промпта и careful design few-shot-примеров.  
2. Необходимо ручное уточнение в спорных случаях (особенно для `predict`/`raw`).  
3. Возможны ложные срабатывания при недостаточно точной формулировке правила в `explanation`.

## Выводы  
Использование LLM позволило реализовать надёжный pipeline интерпретации агрономических сообщений в формализованный JSON. Подход с аннотированными полями даёт гибкость и прозрачность для downstream-задач, включая валидацию, переобучение моделей и анализ неуверенных предсказаний. Работа продемонстрировала высокую применимость LLM в агро-индустрии для автоматизации первичной документации полевых работ.
